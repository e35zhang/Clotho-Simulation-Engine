clotho_version: '3.0'
test:
  invariants:
    - name: BalanceConservation
      # Total balance should remain constant (1000 + 500 + 100 = 1600)
      check: "total_balance_conserved"
      description: "Sum of all balances must equal initial total (no money created/destroyed)"
  cases: []
types: {}
design:
  components:
  - name: BankingService
    state:
    - name: accounts
      schema:
        account_id: INTEGER
        owner: TEXT
        balance: REAL
        status: TEXT
    handlers:
    - on_message: transfer
      logic:
      - read: accounts
        where:
          account_id: '{{trigger.payload.from_account}}'
        as: from_account
      - read: accounts
        where:
          account_id: '{{trigger.payload.to_account}}'
        as: to_account
      - update: accounts
        where:
          account_id: '{{trigger.payload.from_account}}'
        set:
          balance: '{{read.from_account.balance - trigger.payload.amount}}'
      - update: accounts
        where:
          account_id: '{{trigger.payload.to_account}}'
        set:
          balance: '{{read.to_account.balance + trigger.payload.amount}}'
    - on_message: withdraw
      logic:
      - read: accounts
        where:
          account_id: '{{trigger.payload.account_id}}'
        as: account
      - update: accounts
        where:
          account_id: '{{trigger.payload.account_id}}'
        set:
          balance: '{{read.account.balance - trigger.payload.amount}}'
    - on_message: deposit
      logic:
      - read: accounts
        where:
          account_id: '{{trigger.payload.account_id}}'
        as: account
      - update: accounts
        where:
          account_id: '{{trigger.payload.account_id}}'
        set:
          balance: '{{read.account.balance + trigger.payload.amount}}'
run:
  scenarios:
  # Simple scenario with only 2 transfers - ~30% pass rate (good for demo)
  - name: simple_transfer_test
    initial_state:
    - component: BankingService
      storage:
        accounts:
        - account_id: 1
          owner: Alice
          balance: 1000.0
          status: active
        - account_id: 2
          owner: Bob
          balance: 1000.0
          status: active
    steps:
    - send: transfer
      to: BankingService
      payload:
        from_account: 1
        to_account: 2
        amount: 100.0
    - send: transfer
      to: BankingService
      payload:
        from_account: 2
        to_account: 1
        amount: 100.0

  # Complex scenario with many concurrent operations - ~100% fail rate (vulnerable)
  - name: vulnerable_banking_test
    initial_state:
    - component: BankingService
      storage:
        accounts:
        - account_id: 1
          owner: Alice
          balance: 1000.0
          status: active
        - account_id: 2
          owner: Bob
          balance: 500.0
          status: active
        - account_id: 3
          owner: Charlie
          balance: 100.0
          status: frozen
    steps:
    - send: transfer
      to: BankingService
      payload:
        from_account: 1
        to_account: 2
        amount: 50.0
    - send: withdraw
      to: BankingService
      payload:
        account_id: 2
        amount: 100.0
    - send: deposit
      to: BankingService
      payload:
        account_id: 3
        amount: 200.0
    - send: transfer
      to: BankingService
      payload:
          from_account: 2
          to_account: 1
          amount: 25.0
